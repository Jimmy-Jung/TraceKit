# âš™ï¸ ê³ ê¸‰ ê¸°ëŠ¥

> ì‘ì„±ì¼: 2025-12-15
> ì‘ì„±ì: jimmy

> ğŸ’¡ ì´ ë¬¸ì„œì˜ ì˜ˆì œì—ì„œ ì¼ë°˜ ë¡œê¹…ì€ ë™ê¸° API(`Logger.info(...)`)ë¥¼ ì‚¬ìš©í•˜ê³ ,
> ì„±ëŠ¥ ì¶”ì (span), flush ë“± ê²°ê³¼ê°€ í•„ìš”í•œ ê²½ìš°ë§Œ ë¹„ë™ê¸° API(`await Logger.shared...`)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

## ë¡œê·¸ ë²„í¼ë§

### ê°œìš”

ë²„í¼ë§ì€ ë¡œê·¸ ë©”ì‹œì§€ë¥¼ ëª¨ì•„ì„œ í•œ ë²ˆì— ì²˜ë¦¬í•˜ì—¬ I/O ì˜¤ë²„í—¤ë“œë¥¼ ì¤„ì…ë‹ˆë‹¤.

```mermaid
%%{init: {
  'theme': 'dark',
  'themeVariables': { 'lineColor': '#e2e8f0', 'textColor': '#f8fafc' }
}}%%
sequenceDiagram
    participant App as ğŸ“± App
    participant B as ğŸ“¦ Buffer
    participant D as ğŸ“¤ Destination

    App->>B: log #1
    App->>B: log #2
    App->>B: log #3
    
    Note over B: ë²„í¼ ê°€ë“ ë˜ëŠ” íƒ€ì´ë¨¸
    
    B->>D: flush([#1, #2, #3])
    D-->>B: done
```

### LogBufferPolicy

```swift
public struct LogBufferPolicy {
    let maxSize: Int              // ìµœëŒ€ ë²„í¼ í¬ê¸°
    let flushInterval: TimeInterval  // ìë™ í”ŒëŸ¬ì‹œ ê°„ê²©
    let flushOnLevel: LogLevel?   // ì´ ë ˆë²¨ ì´ìƒì´ë©´ ì¦‰ì‹œ í”ŒëŸ¬ì‹œ
    let flushOnBackground: Bool   // ë°±ê·¸ë¼ìš´ë“œ ì§„ì… ì‹œ í”ŒëŸ¬ì‹œ
}
```

### í”„ë¦¬ì…‹

```swift
// ê¸°ë³¸ ì •ì±…
LogBufferPolicy.default
// maxSize: 100, flushInterval: 5ì´ˆ, flushOnLevel: .error

// ì‹¤ì‹œê°„ (ë²„í¼ë§ ì—†ìŒ)
LogBufferPolicy.realtime
// maxSize: 1, flushInterval: 0

// ë°°í„°ë¦¬ ì ˆì•½
LogBufferPolicy.batterySaver
// maxSize: 200, flushInterval: 30ì´ˆ
```

### ì‚¬ìš©ë²•

```swift
let logger = await LoggerBuilder()
    .addConsole()
    .withBuffer(policy: .default)
    .buildAsShared()

// ìˆ˜ë™ í”ŒëŸ¬ì‹œ
Task {
    await Logger.shared.flush()
}
```

### ì»¤ìŠ¤í…€ ì •ì±…

```swift
let customPolicy = LogBufferPolicy(
    maxSize: 50,
    flushInterval: 10.0,
    flushOnLevel: .warning,  // warning ì´ìƒì€ ì¦‰ì‹œ í”ŒëŸ¬ì‹œ
    flushOnBackground: true
)

let logger = await LoggerBuilder()
    .withBuffer(policy: customPolicy)
    .buildAsShared()
```

## ë¡œê·¸ ìƒ˜í”Œë§

### ê°œìš”

í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ë¡œê·¸ ë³¼ë¥¨ì„ ì œì–´í•©ë‹ˆë‹¤. ëª¨ë“  ë¡œê·¸ë¥¼ ìˆ˜ì§‘í•˜ë©´ ë¹„ìš©ì´ ì¦ê°€í•˜ê³  ë¶„ì„ì´ ì–´ë ¤ì›Œì§‘ë‹ˆë‹¤.

### SamplingPolicy

```swift
public struct SamplingPolicy {
    let defaultRate: Double           // ê¸°ë³¸ ë¹„ìœ¨ (0.0 ~ 1.0)
    let ratesByLevel: [LogLevel: Double]   // ë ˆë²¨ë³„ ë¹„ìœ¨
    let ratesByCategory: [String: Double]  // ì¹´í…Œê³ ë¦¬ë³„ ë¹„ìœ¨
    let alwaysIncludeLevels: Set<LogLevel> // í•­ìƒ í¬í•¨í•  ë ˆë²¨
}
```

### í”„ë¦¬ì…‹

```swift
// ë””ë²„ê·¸ìš© (100% ìˆ˜ì§‘)
SamplingPolicy.debug
// defaultRate: 1.0, alwaysIncludeLevels: ëª¨ë“  ë ˆë²¨

// í”„ë¡œë•ì…˜ìš©
SamplingPolicy.production
// defaultRate: 0.1 (10%)
// verbose: 1%, debug: 5%, info: 10%, warning: 50%
// error, fatal: 100%

// ìµœì†Œ ìƒ˜í”Œë§
SamplingPolicy.minimal
// defaultRate: 0.01 (1%)
// error, fatal: 100%
```

### ì‚¬ìš©ë²•

```swift
let logger = await LoggerBuilder()
    .addConsole()
    .withSampling(policy: .production)
    .buildAsShared()
```

### ì»¤ìŠ¤í…€ ì •ì±…

```swift
let customPolicy = SamplingPolicy(
    defaultRate: 0.2,  // ê¸°ë³¸ 20%
    ratesByLevel: [
        .verbose: 0.0,   // verboseëŠ” ìˆ˜ì§‘í•˜ì§€ ì•ŠìŒ
        .debug: 0.05,    // debugëŠ” 5%
        .warning: 1.0    // warningì€ 100%
    ],
    ratesByCategory: [
        "Network": 0.5,  // Network ì¹´í…Œê³ ë¦¬ëŠ” 50%
        "Auth": 1.0      // Auth ì¹´í…Œê³ ë¦¬ëŠ” 100%
    ],
    alwaysIncludeLevels: [.error, .fatal]
)
```

### ìƒ˜í”Œë§ ë™ì‘ ì›ë¦¬

```swift
// 1. alwaysIncludeLevelsì— ìˆìœ¼ë©´ 100%
if alwaysIncludeLevels.contains(message.level) {
    return 1.0
}

// 2. ë ˆë²¨ë³„ ë¹„ìœ¨ì´ ìˆìœ¼ë©´ ìš°ì„ 
if let levelRate = ratesByLevel[message.level] {
    return levelRate
}

// 3. ì¹´í…Œê³ ë¦¬ë³„ ë¹„ìœ¨ì´ ìˆìœ¼ë©´ ì‚¬ìš©
if let categoryRate = ratesByCategory[message.category] {
    return categoryRate
}

// 4. ê¸°ë³¸ ë¹„ìœ¨
return defaultRate
```

## ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹

### ê°œìš”

ë¡œê·¸ì— í¬í•¨ë  ìˆ˜ ìˆëŠ” ë¯¼ê°ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ë§ˆìŠ¤í‚¹í•©ë‹ˆë‹¤.

### ê¸°ë³¸ íŒ¨í„´

| íŒ¨í„´ | ì˜ˆì‹œ | ë§ˆìŠ¤í‚¹ ê²°ê³¼ |
|-----|------|-----------|
| ì´ë©”ì¼ | `john@example.com` | `[EMAIL]` |
| ì‹ ìš©ì¹´ë“œ | `1234-5678-9012-3456` | `[CREDIT_CARD]` |
| ì „í™”ë²ˆí˜¸ | `010-1234-5678` | `[PHONE]` |
| IP ì£¼ì†Œ | `192.168.1.1` | `[IP_ADDRESS]` |
| JWT | `eyJhbGciOiJI...` | `[JWT_TOKEN]` |
| UUID | `550e8400-e29b-...` | `[UUID]` |
| ë¹„ë°€ë²ˆí˜¸ | `password=secret123` | `password=[MASKED]` |

### ì‚¬ìš©ë²•

```swift
// ê¸°ë³¸ ì •ì œê¸° ì‚¬ìš©
let logger = await LoggerBuilder()
    .withDefaultSanitizer()
    .buildAsShared()

// ë§ˆìŠ¤í‚¹ ë™ì‘ (ë™ê¸° API ì‚¬ìš©)
Logger.info("ì‚¬ìš©ì ì´ë©”ì¼: john@example.com")
// ì¶œë ¥: "ì‚¬ìš©ì ì´ë©”ì¼: [EMAIL]"
```

### ì»¤ìŠ¤í…€ íŒ¨í„´ ì¶”ê°€

```swift
let customSanitizer = DefaultLogSanitizer.Builder()
    // ê¸°ë³¸ íŒ¨í„´ì— ì¶”ê°€
    .add(try! SensitiveDataPattern(
        name: "Korean SSN",
        pattern: #"\d{6}-\d{7}"#,
        replacement: "[SSN]"
    ))
    .add(try! SensitiveDataPattern(
        name: "API Key",
        pattern: #"api[_-]?key[=:]\s*[\w-]+"#,
        replacement: "api_key=[REDACTED]"
    ))
    .build()

let logger = await LoggerBuilder()
    .withSanitizer(customSanitizer)
    .buildAsShared()
```

### ë¹ˆ íŒ¨í„´ìœ¼ë¡œ ì‹œì‘

```swift
// ê¸°ë³¸ íŒ¨í„´ ì—†ì´ ì»¤ìŠ¤í…€ íŒ¨í„´ë§Œ ì‚¬ìš©
let minimalSanitizer = DefaultLogSanitizer.Builder.empty()
    .add(try! SensitiveDataPattern(
        name: "Custom Secret",
        pattern: #"SECRET_\w+"#,
        replacement: "[SECRET]"
    ))
    .build()
```

### ë§ˆìŠ¤í‚¹ ë¹„í™œì„±í™”

```swift
// ì„¤ì •ì—ì„œ ë¹„í™œì„±í™”
let config = LoggerConfiguration(isSanitizingEnabled: false)

// ë˜ëŠ” ì •ì œê¸° ìì²´ë¥¼ ë¹„í™œì„±í™”
let disabledSanitizer = DefaultLogSanitizer(isEnabled: false)
```

## ì„±ëŠ¥ ì¶”ì 

### ê°œìš”

ì½”ë“œ ì‹¤í–‰ ì‹œê°„ì„ ì¸¡ì •í•˜ê³  ë¡œê·¸ë¡œ ê¸°ë¡í•©ë‹ˆë‹¤.

### ìë™ ì¸¡ì • (measure)

```swift
// í•¨ìˆ˜ ì‹¤í–‰ ì‹œê°„ ìë™ ì¸¡ì •
let result = await Logger.shared.measure(name: "ë°ì´í„° ë¡œë”©") {
    await loadData()
}

// ì¶œë ¥ ì˜ˆì‹œ:
// [PERF] ë°ì´í„° ë¡œë”©: 1.234s
```

### ìˆ˜ë™ ì¸¡ì • (Span)

```swift
// ì‹œì‘
let spanId = await Logger.shared.startSpan(name: "ë³µì¡í•œ ì‘ì—…")

// ... ì‘ì—… ìˆ˜í–‰ ...

// ì¢…ë£Œ (ë©”íƒ€ë°ì´í„° ì¶”ê°€ ê°€ëŠ¥)
await Logger.shared.endSpan(
    id: spanId,
    metadata: ["itemCount": AnyCodable(100)]
)
```

### ì¤‘ì²© Span

```swift
// ë¶€ëª¨ Span
let parentId = await Logger.shared.startSpan(name: "ì „ì²´ ì‘ì—…")

    // ìì‹ Span 1
    let child1Id = await Logger.shared.startSpan(
        name: "ë°ì´í„° ë¡œë”©",
        parentId: parentId
    )
    await loadData()
    await Logger.shared.endSpan(id: child1Id)
    
    // ìì‹ Span 2
    let child2Id = await Logger.shared.startSpan(
        name: "ë°ì´í„° ì²˜ë¦¬",
        parentId: parentId
    )
    await processData()
    await Logger.shared.endSpan(id: child2Id)

// ë¶€ëª¨ ì¢…ë£Œ
await Logger.shared.endSpan(id: parentId)
```

### ì‹¤ì „ ì˜ˆì œ: API í˜¸ì¶œ ì¶”ì 

```swift
actor NetworkService {
    func fetchUser(id: String) async throws -> User {
        let spanId = await Logger.shared.startSpan(name: "fetchUser")
        
        defer {
            Task {
                await Logger.shared.endSpan(id: spanId)
            }
        }
        
        // ë„¤íŠ¸ì›Œí¬ ìš”ì²­
        let requestSpan = await Logger.shared.startSpan(
            name: "HTTP Request",
            parentId: spanId
        )
        let (data, _) = try await urlSession.data(from: url)
        await Logger.shared.endSpan(id: requestSpan)
        
        // JSON íŒŒì‹±
        let parseSpan = await Logger.shared.startSpan(
            name: "JSON Parsing",
            parentId: spanId
        )
        let user = try decoder.decode(User.self, from: data)
        await Logger.shared.endSpan(id: parseSpan)
        
        return user
    }
}
```

## í¬ë˜ì‹œ ë¡œê·¸ ë³´ì¡´

### ê°œìš”

ì•± í¬ë˜ì‹œ ì§ì „ì˜ ë¡œê·¸ë¥¼ íŒŒì¼ì— ë³´ì¡´í•˜ì—¬ í¬ë˜ì‹œ ì›ì¸ ë¶„ì„ì— í™œìš©í•©ë‹ˆë‹¤.

### ì‚¬ìš©ë²•

```swift
let logger = await LoggerBuilder()
    .addConsole()
    .withCrashPreservation(count: 50)  // ìµœê·¼ 50ê°œ ë¡œê·¸ ë³´ì¡´
    .buildAsShared()
```

### í¬ë˜ì‹œ í›„ ë¡œê·¸ ë³µêµ¬

```swift
// ë‹¤ìŒ ì•± ì‹¤í–‰ ì‹œ
Task {
    if let crashLogs = await Logger.shared.recoverCrashLogs() {
        for log in crashLogs {
            print("í¬ë˜ì‹œ ì „ ë¡œê·¸: \(log)")
        }
        
        // ì™¸ë¶€ ì„œë¹„ìŠ¤ë¡œ ì „ì†¡
        await analyticsService.sendCrashLogs(crashLogs)
        
        // ì •ë¦¬
        await Logger.shared.clearCrashLogs()
    }
}
```

## ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸

### ê°œìš”

ëª¨ë“  ë¡œê·¸ì— ìë™ìœ¼ë¡œ ì‚¬ìš©ì/ì•± ì •ë³´ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

### UserContext

```swift
public struct UserContext {
    let userId: String?
    let sessionId: String
    let appVersion: String
    let osVersion: String
    let deviceModel: String
    let environment: Environment
}
```

### ê¸°ë³¸ ì»¨í…ìŠ¤íŠ¸ ì œê³µì

```swift
let logger = await LoggerBuilder()
    .withDefaultContextProvider(environment: .production)
    .buildAsShared()

// ë¡œê·¸ ì¶œë ¥ì— ìë™ í¬í•¨ (ë™ê¸° API ì‚¬ìš©)
Logger.info("ì‚¬ìš©ì ì•¡ì…˜")
// metadataì— appVersion, osVersion, deviceModel ìë™ ì¶”ê°€
```

### ì»¤ìŠ¤í…€ ì»¨í…ìŠ¤íŠ¸ ì œê³µì

```swift
actor MyContextProvider: UserContextProvider {
    func currentContext() async -> UserContext {
        return UserContext(
            userId: await AuthManager.shared.currentUserId,
            sessionId: SessionManager.current.id,
            appVersion: Bundle.main.appVersion,
            osVersion: UIDevice.current.systemVersion,
            deviceModel: UIDevice.current.model,
            environment: .production
        )
    }
}

let logger = await LoggerBuilder()
    .withContextProvider(MyContextProvider())
    .buildAsShared()
```

## íŒŒì¼ ë¡œê·¸ ê´€ë¦¬

### LogFileRetentionPolicy

```swift
public struct LogFileRetentionPolicy {
    let maxFileSize: Int64     // ìµœëŒ€ íŒŒì¼ í¬ê¸°
    let maxFileCount: Int      // ìµœëŒ€ íŒŒì¼ ê°œìˆ˜
    let maxAge: TimeInterval   // ìµœëŒ€ ë³´ê´€ ê¸°ê°„
}
```

### í”„ë¦¬ì…‹

```swift
// ê¸°ë³¸
LogFileRetentionPolicy.default
// 10MB, 5ê°œ, 7ì¼

// ìƒì„¸ ë³´ê´€
LogFileRetentionPolicy.detailed
// 50MB, 10ê°œ, 30ì¼

// ìµœì†Œ ë³´ê´€
LogFileRetentionPolicy.minimal
// 5MB, 3ê°œ, 3ì¼
```

### ì‚¬ìš©ë²•

```swift
let logger = await LoggerBuilder()
    .addFile(
        minLevel: .info,
        retentionPolicy: LogFileRetentionPolicy(
            maxFileSize: 20 * 1024 * 1024,  // 20MB
            maxFileCount: 10,
            maxAge: 14 * 24 * 3600          // 14ì¼
        )
    )
    .buildAsShared()
```

## ë‹¤ìŒ ë‹¨ê³„

- [ì™¸ë¶€ ì—°ë™](./05-ì™¸ë¶€-ì—°ë™.md) - Sentry, Datadog, Firebase ì—°ë™
- [ëŸ°íƒ€ì„ ì„¤ì •](./06-ëŸ°íƒ€ì„-ì„¤ì •.md) - Launch Arguments

