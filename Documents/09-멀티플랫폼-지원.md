# 멀티플랫폼 지원 가이드

## 지원 플랫폼

TraceKit는 모든 Apple 플랫폼을 지원합니다:

| 플랫폼 | 최소 버전 | 상태 |
|--------|----------|------|
| iOS | 15.0+ | ✅ 전체 지원 |
| macOS | 12.0+ | ✅ 전체 지원 |
| tvOS | 15.0+ | ✅ 전체 지원 |
| watchOS | 8.0+ | ✅ 전체 지원 |
| visionOS | 1.0+ | ✅ 전체 지원 |

## 플랫폼별 차이점

### 1. 파일 저장 경로

TraceKit는 각 플랫폼의 특성에 맞는 디렉토리를 자동으로 선택합니다:

```swift
// iOS, tvOS, visionOS
~/Library/Caches/Logs/

// macOS
~/Library/Logs/[BundleIdentifier]/

// watchOS
~/Documents/Logs/
```

### 2. 플랫폼별 제약사항

#### iOS
- 제약사항 없음
- 모든 기능 완전 지원

#### macOS
- 제약사항 없음
- macOS 표준 로그 경로 사용 (~/Library/Logs)

#### tvOS
- 제약사항 없음
- 백그라운드 실행 제한 고려

#### watchOS
- ⚠️ 저장 공간 제한적 (약 75MB)
- 파일 로그 사용 시 작은 retentionPolicy 권장
- 복잡한 로그 포맷은 성능 영향 고려

```swift
// watchOS 권장 설정
let retentionPolicy = LogFileRetentionPolicy(
    retentionDays: 2,
    maxFileSize: 256 * 1024,  // 256KB
    maxTotalSize: 1 * 1024 * 1024  // 1MB
)
```

#### visionOS
- 제약사항 없음
- 공간 컴퓨팅 특성상 OSLog 권장

### 3. OSLog 가용성

OSLog는 다음 버전부터 사용 가능합니다:

```swift
@available(iOS 14.0, macOS 11.0, tvOS 14.0, watchOS 7.0, *)
```

TraceKit는 자동으로 플랫폼 버전을 체크하여 OSLog 사용 가능 여부를 판단합니다.

## 플랫폼별 권장 구성

### iOS / visionOS (일반 앱)

```swift
let logger = await TraceKitBuilder()
    .addConsole(formatter: PrettyLogFormatter.standard)
    .addOSLog()
    .addFile()
    .withDefaultSanitizer()
    .buildAsShared()
```

### macOS (데스크톱 앱)

```swift
let logger = await TraceKitBuilder()
    .addConsole()
    .addOSLog()
    .addFile()  // ~/Library/Logs/BundleID/
    .withDefaultSanitizer()
    .buildAsShared()
```

### tvOS (TV 앱)

```swift
let logger = await TraceKitBuilder()
    .addConsole()
    .addOSLog()
    // 파일 로그는 선택적
    .buildAsShared()
```

### watchOS (워치 앱)

```swift
// 최소 설정 권장
let logger = await TraceKitBuilder()
    .addConsole(formatter: PrettyLogFormatter.minimal)
    .addOSLog()
    .buildAsShared()

// 파일 로그가 필요한 경우
let retentionPolicy = LogFileRetentionPolicy(
    retentionDays: 1,
    maxFileSize: 128 * 1024,
    maxTotalSize: 512 * 1024
)

let logger = await TraceKitBuilder()
    .addOSLog()
    .addFile(retentionPolicy: retentionPolicy)
    .buildAsShared()
```

## 조건부 컴파일

플랫폼별로 다른 설정이 필요한 경우:

```swift
let logger = await TraceKitBuilder()
    .addConsole()
    .addOSLog()

#if os(watchOS)
    // watchOS는 파일 로그 제외
#else
    .addFile()
#endif
    .buildAsShared()
```

또는:

```swift
#if os(iOS) || os(visionOS)
let logger = await TraceKitBuilder.production().buildAsShared()
#elseif os(macOS)
let logger = await TraceKitBuilder()
    .addConsole()
    .addOSLog()
    .addFile()
    .buildAsShared()
#elseif os(watchOS)
let logger = await TraceKitBuilder()
    .addOSLog()
    .buildAsShared()
#elseif os(tvOS)
let logger = await TraceKitBuilder()
    .addConsole()
    .addOSLog()
    .buildAsShared()
#endif
```

## 플랫폼 감지

런타임에 플랫폼을 감지하려면:

```swift
#if os(iOS)
await TraceKit.async.info("iOS에서 실행 중")
#elseif os(macOS)
await TraceKit.async.info("macOS에서 실행 중")
#elseif os(tvOS)
await TraceKit.async.info("tvOS에서 실행 중")
#elseif os(watchOS)
await TraceKit.async.info("watchOS에서 실행 중")
#elseif os(visionOS)
await TraceKit.async.info("visionOS에서 실행 중")
#endif
```

## 외부 연동 모듈 지원

| 모듈 | iOS | macOS | tvOS | watchOS | visionOS |
|------|-----|-------|------|---------|----------|
| TraceKitSentry | ✅ | ✅ | ✅ | ✅ | ✅ |
| TraceKitDatadog | ✅ | ✅ | ✅ | ✅ | ✅ |
| TraceKitFirebase | ✅ | ✅ | ✅ | ⚠️ | ✅ |

⚠️ Firebase watchOS 지원은 제한적일 수 있습니다. 공식 문서를 확인하세요.

## CI/CD

GitHub Actions에서 모든 플랫폼 테스트:

```yaml
jobs:
  test-ios:
    runs-on: macos-14
    steps:
      - run: xcodebuild test -scheme TraceKit -destination "platform=iOS Simulator"
  
  test-macos:
    runs-on: macos-14
    steps:
      - run: xcodebuild test -scheme TraceKit -destination "platform=macOS"
  
  test-tvos:
    runs-on: macos-14
    steps:
      - run: xcodebuild test -scheme TraceKit -destination "platform=tvOS Simulator"
  
  test-watchos:
    runs-on: macos-14
    steps:
      - run: xcodebuild build -scheme TraceKit -destination "platform=watchOS Simulator"
  
  test-visionos:
    runs-on: macos-14
    steps:
      - run: xcodebuild test -scheme TraceKit -destination "platform=visionOS Simulator"
```

## 트러블슈팅

### watchOS에서 파일 쓰기 실패

```swift
// 문제: watchOS 저장 공간 부족
// 해결: retentionPolicy를 더 작게 설정

let policy = LogFileRetentionPolicy(
    retentionDays: 1,
    maxFileSize: 100 * 1024,  // 100KB
    maxTotalSize: 500 * 1024   // 500KB
)
```

### macOS에서 로그 파일 찾기

```bash
# 앱 로그 위치
~/Library/Logs/[BundleIdentifier]/

# 예시
~/Library/Logs/com.example.MyApp/
```

### visionOS 시뮬레이터 이슈

visionOS 시뮬레이터는 Xcode 15.2+ 필요:

```bash
# Xcode 버전 확인
xcodebuild -version

# visionOS 시뮬레이터 목록
xcrun simctl list devices visionOS
```

## 성능 고려사항

### watchOS
- 로그 레벨을 `.info` 이상으로 제한
- 복잡한 포맷터 사용 자제
- 샘플링 적극 활용

```swift
let sampler = LogSampler(defaultRate: 0.1)  // 10%만 로깅
await logger.setSampler(sampler)
```

### tvOS
- 백그라운드에서 파일 쓰기 완료 보장
- 앱 종료 시 `flush()` 호출

```swift
// tvOS 앱 종료 시
func applicationWillTerminate(_ application: UIApplication) {
    Task {
        await TraceKit.async.flush()
    }
}
```

## 참고 자료

- [Apple Platform Deployment](https://developer.apple.com/documentation/xcode/supporting-multiple-platforms-in-your-app)
- [watchOS App Essentials](https://developer.apple.com/documentation/watchos-apps)
- [visionOS Development](https://developer.apple.com/visionos/)
